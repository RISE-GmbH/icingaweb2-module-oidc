<?php

/* originally from Icinga Web 2 X.509 Module | (c) 2018 Icinga GmbH | GPLv2 */
/* generated by icingaweb2-module-scaffoldbuilder | GPLv2+ */

namespace Icinga\Module\Oidc;

use DateTime;
use DateTimeZone;
use Icinga\Authentication\Auth;
use Icinga\Module\Oidc\Model\User;
use Icinga\Web\Url;
use ipl\Html\Html;
use ipl\Orm\Model;
use ipl\Web\Widget\Icon;

/**
 * Table widget to display a list of Users
 */
class UserTable extends DataTable
{
    protected $defaultAttributes = [
        'class'            => 'usage-table common-table',

    ];

    public function createColumns()
    {
        $column = [];
        foreach ((new User())->getColumnDefinitions() as $column=>$options){

            if(is_array($options)) {
                $fieldtype = $options['fieldtype'] ?? "text";

                unset($options['fieldtype']);
                if ($column === "provider_id" ){
                    $columns[$column."_txt"] = [
                        'label'  => $options['label']??$column,
                        'column' => function ($data) use ($column) {
                            if($data->{$column}!=null){
                                return $data->provider->name;
                            }
                            return t("not set");
                        }
                    ];
                    continue;
                }

                if ($column === "name"){
                    $columns[$column."_link"] = [
                        'label'  => $options['label']??$column,
                        'column' => function ($data) use ($column) {
                             return Html::tag('a',['data-base-target'=>'_next',"href"=>\ipl\Web\Url::fromPath("user/show", ['backend'=>$data->provider->name, 'user'=>$data->name])],$data->name);
                        }
                    ];
                    continue;
                }

                if ($fieldtype === "autocomplete" || $fieldtype === "text" || $fieldtype === "select") {
                    $columns[$column] = $options['label']??$column;

                }elseif ($fieldtype === "checkbox"){
                    $columns[$column."_text"] = [
                        'label'  => $options['label']??$column,
                        'column' => function ($data) use ($column) {
                            return intval($data->{$column}) == 1?t('Yes'):t('No') ;
                        }
                    ];
                }elseif ($fieldtype === "localDateTime" ){
                    $columns[$column."_txt"] = [
                        'label'  => $options['label']??$column,
                        'column' => function ($data) use ($column) {
                            if($data->{$column}!=null){
                                return $data->{$column}->format("c");
                            }
                            return t("not set");
                        }
                    ];
                }
            }else{
                $columns[$column] = $options;
            }
        }
        if (Auth::getInstance()->hasPermission('oidc/user/modify')) {
            $columns['action'] = [
                'label' => mt('packagemirror', 'Action'),
                'attributes' => ['class' => 'icon-col'],
                'column' => function ($data) {
                    return $data;
                },
                'renderer' => function ($data) {
                    $div=Html::tag("div",['class'=>'action-column']);

                    $icon=  new Icon('pencil', ['title' => mt('oidc', 'Edit')]);
                    $a = Html::tag("a",['data-icinga-modal' => true, 'data-no-icinga-ajax' => true, 'class'=>'action-item','href'=> \ipl\Web\Url::fromPath('oidc/user/edit',['id'=>$data->id])]);
                    $a->add($icon);
                    $div->add($a);#


                    return $div;
                }
            ];
        }


        return $columns;
    }


    protected function renderRow(Model $row)
    {
        $tr = parent::renderRow($row);

        return $tr;
    }
}
